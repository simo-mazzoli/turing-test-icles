<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        margin: 0;
        padding: 0;
        background: url("https://drive.google.com/thumbnail?id=1o9mVqWg3qO4MUOS7lmoyGfPtQe4LHfEn&sz=w2000") 
                    no-repeat center center / cover;
        background-size: cover;
        font-family: Arial, sans-serif;

        /* CENTER ONLY HORIZONTALLY */
        display: flex;
        flex-direction: column;
        align-items: center;   /* center left–right */
        justify-content: flex-start; /* top of page */
        min-height: 100vh;
      }

      .header-img {
        display: block;
        width: 55vw;
        height: auto;
        margin: 20px auto;
      }

      .container {
        background: rgba(255, 255, 255, 0.9);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0px 4px 15px rgba(0,0,0,0.2);
        max-width: 600px;
        width: 90%;
        text-align: center;

        /* ensure container stays centered */
        margin: 20px auto;
      }

      input[type="text"] {
        width: 80%;
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 5px;
        border: 1px solid #ccc;
        font-size: 16px;
      }

      button {
        padding: 10px 20px;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
        background-color: #4285F4;
        color: white;
      }

      button:hover {
        background-color: #357AE8;
      }

      #contatore {
        margin-bottom: 15px;
        font-weight: bold;
      }

      #risposte p {
        text-align: left;
      }
    </style>

  </head>
  <body>
    <img src="https://drive.google.com/thumbnail?id=1HAcRE5hYyNkniMQob_kmDqqlVMxewJ_9&sz=w2000" class="header-img" alt="Header">
    <div class="container">
      <h2>Turing Test - Giocatore</h2>
      <div id="contatore"></div>
      <div id="game"></div>
    </div>

    <script>
      let count = 0;
      let giocatoreId;
      let currentRow;
      let isAIinA = null;  // determina se la risposta AI sarà mostrata come A o B

      function resetGioco() {
        count = 0;
        giocatoreId = Date.now();
        currentRow = null;
        isAIinA = Math.random() < 0.5;  // assegna casualmente AI a A o B all'inizio della sessione
        aggiornaContatore();
        nuovaDomanda();
      }

      function aggiornaContatore() {
        document.getElementById("contatore").innerText = `Domande fatte: ${count}`;
      }

      function nuovaDomanda() {
        if (!giocatoreId) giocatoreId = Date.now();

        document.getElementById("game").innerHTML = `
          <input type="text" id="domanda" placeholder="Scrivi la tua domanda">
          <button id="inviaBtn" onclick="inviaDomanda()">Invia</button>
          <div id="loading" style="margin-top:15px;"></div>
          <div id="risposte"></div>
        `;
        // svuota eventuale loading/risposte
        const loadingDiv = document.getElementById("loading");
        if (loadingDiv) loadingDiv.style.display = "none";
      }

      function inviaDomanda() {
        const domandaInput = document.getElementById("domanda");
        const domanda = domandaInput ? domandaInput.value.trim() : "";
        if (!domanda) {
          alert("Inserisci una domanda prima di inviare.");
          return;
        }

        // mostra animazione di caricamento
        const loading = document.getElementById("loading");
        if (loading) {
          loading.innerHTML = `
            <video autoplay loop muted width="100">
              <source src="https://cdn-icons-mp4.flaticon.com/512/10971/10971777.mp4" type="video/mp4">
              Il tuo browser non supporta il video.
            </video>
          `;
        }

        // disabilita il pulsante per evitare invii multipli
        const btn = document.getElementById("inviaBtn");
        if (btn) btn.disabled = true;

        google.script.run.withSuccessHandler(riga => {
          currentRow = riga;
          // avvia la routine di controllo (polling)
          controllaDestinatario(riga, domanda);
        }).salvaDomanda(domanda, giocatoreId);
      }

      function controllaDestinatario(riga, domanda) {
        google.script.run.withSuccessHandler(risposte => {
          // se la risposta del destinatario non è ancora presente, ritenta dopo 2s
          if (!risposte.rispostaDestinatario) {
            setTimeout(() => controllaDestinatario(riga, domanda), 2000);
          } else {
            // quando la risposta umana è presente, chiama Gemini per generare la risposta AI
            google.script.run.withSuccessHandler(() => {
              aggiornaRisposte();
            }).chiamaGemini(domanda, riga);
          }
        }).getRisposte(riga);
      }

      function aggiornaRisposte() {
        google.script.run.withSuccessHandler(risposte => {
          const loadingDiv = document.getElementById("loading");
          if (loadingDiv) loadingDiv.style.display = "none";

          // Mostra la domanda
          let html = `<p><b>Domanda:</b> ${risposte.domanda}</p>`;

          const rispostaUmana = risposte.rispostaDestinatario;
          const rispostaAI = risposte.rispostaAI;

          if (!rispostaUmana || !rispostaAI) {
            html += `
              <p><b>Risposta A:</b> In attesa...</p>
              <p><b>Risposta B:</b> In attesa...</p>
            `;
            document.getElementById("risposte").innerHTML = html;
            // riabilita il pulsante per permettere nuovo invio se necessario
            const btn = document.getElementById("inviaBtn");
            if (btn) btn.disabled = false;
            return;
          }

          // Mappa A e B in base a isAIinA
          let rispostaA, rispostaB;
          if (isAIinA === null) {
            console.error("Errore: isAIinA non inizializzato.");
            isAIinA = Math.random() < 0.5;
          }

          if (isAIinA) {
            rispostaA = rispostaAI;
            rispostaB = rispostaUmana;
          } else {
            rispostaA = rispostaUmana;
            rispostaB = rispostaAI;
          }

          html += `
            <p><b>Risposta A:</b> ${rispostaA}</p>
            <p><b>Risposta B:</b> ${rispostaB}</p>
            <br><button onclick="nuovaDomanda()">Poni la prossima domanda</button>
            <button onclick="mostraScelte()">Scegli chi pensi sia umano</button>
          `;

          document.getElementById("risposte").innerHTML = html;

          // aggiorna contatore e riabilita eventuale invio futuro
          count++;
          aggiornaContatore();

          const btn = document.getElementById("inviaBtn");
          if (btn) btn.disabled = false;
        }).getRisposte(currentRow);
      }

      function mostraScelte() {
        // mostra due pulsanti per scelta (A o B) — qui puoi sostituire con logica di invio risultato
        const html = `
          <p>Chi pensi sia umano?</p>
          <button onclick="alert('Hai scelto A!')">Risposta A</button>
          <button onclick="alert('Hai scelto B!')">Risposta B</button>
          <br><br>
          <button onclick="nuovaDomanda()">Poni la prossima domanda</button>
        `;
        document.getElementById("risposte").innerHTML = html;
      }

      // Inizia il gioco
      resetGioco();
    </script>
  </body>
</html>
